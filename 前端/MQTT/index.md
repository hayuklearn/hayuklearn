[TOC]

# [MQTT](https://mqtt.org/)

```
Message Queuing Telemetry Transport

消息队列遥测传输协议
```

## 主要特性

```
MQTT 协议工作在低带宽、不可靠的网络的远程传感器和控制设备通讯而设计的协议

它具有以下主要的几项特性：

（1）使用发布/订阅消息模式，提供一对多的消息发布，解除应用程序耦合。

这一点很类似于 XMPP，但是 MQTT 的信息冗余远小于 XMPP，
因为 XMPP 使用 XML 格式文本来传递数据。

（2）对负载内容屏蔽的消息传输。

（3）使用 TCP/IP 提供网络连接。

主流的 MQTT 是基于 TCP 连接进行数据推送的，但是同样有基于 UDP 的版本，叫做 MQTT-SN。
这两种版本由于基于不同的连接方式，优缺点自然也就各有不同了。

（4）有三种消息发布服务质量：

"至多一次"，消息发布完全依赖底层 TCP/IP 网络。会发生消息丢失或重复。
这一级别可用于如下情况，环境传感器数据，丢失一次读记录无所谓，因为不久后还会有第二次发送。
这一种方式主要普通 APP 的推送，倘若你的智能设备在消息推送时未联网，
推送过去没收到，再次联网也就收不到了。

"至少一次"，确保消息到达，但消息重复可能会发生。

"只有一次"，确保消息到达一次。在一些要求比较严格的计费系统中，可以使用此级别。
在计费系统中，消息重复或丢失会导致不正确的结果。
这种最高质量的消息发布服务还可以用于即时通讯类的APP的推送，确保用户收到且只会收到一次。

（5）小型传输，开销很小（固定长度的头部是2字节），协议交换最小化，以降低网络流量。

这就是为什么说它非常适合"在物联网领域，传感器与服务器的通信，信息的收集"，
嵌入式设备的运算能力和带宽都相对薄弱，使用这种协议来传递消息再适合不过了。

（6）使用 Last Will 和 Testament 特性通知有关各方客户端异常中断的机制。

Last Will：即遗言机制，用于通知同一主题下的其他设备发送遗言的设备已经断开了连接。

Testament：遗嘱机制，功能类似于 Last Will。
```

## 实现方式

```
实现 MQTT 协议需要客户端和服务器端通讯完成，在通讯过程中，MQTT 协议中有三种身份：
1. 发布者（Publish）
2. 代理（Broker）（服务器）
3. 订阅者（Subscribe）
其中，消息的发布者和订阅者都是客户端，消息代理是服务器，消息发布者可以同时是订阅者。

MQTT 传输的消息分为：主题（Topic）和负载（payload）两部分：

1. Topic，可以理解为消息的类型，订阅者订阅（Subscribe）后，就会收到该主题的消息内容（payload）；
2. payload，可以理解为消息的内容，是指订阅者具体要使用的内容。
```

![](./img/mqtt-fidge-2.svg)

## 客户端

```
一个使用 MQTT 协议的应用程序或者设备，它总是建立到服务器的网络连接。客户端可以：

（1）发布其他客户端可能会订阅的信息；
（2）订阅其它客户端发布的消息；
（3）退订或删除应用程序的消息；
（4）断开与服务器连接。
```

## 服务端

```
MQTT 服务器以称为"消息代理"（Broker），可以是一个应用程序或一台设备。
它是位于消息发布者和订阅者之间，它可以：

（1）接受来自客户的网络连接；
（2）接受客户发布的应用信息；
（3）处理来自客户端的订阅和退订请求；
（4）向订阅的客户转发应用程序消息。
```

## 数据包格式

```
在 MQTT 协议中，一个 MQTT 数据包由：
固定头（Fixed header）、
可变头（Variable header）、
消息体（payload）
三部分构成。MQTT 数据包结构如下：

（1）固定头（Fixed header）。存在于所有 MQTT 数据包中，表示数据包类型及数据包的分组类标识。
（2）可变头（Variable header）。存在于部分 MQTT 数据包中，数据包类型决定了可变头是否存在及其具体内容。
（3）消息体（Payload）。存在于部分 MQTT 数据包中，表示客户端收到的具体内容。
```

|FixedHeader|VariableHeader|Payload|
|:--:|:--:|:--:|

### 固定头 FixedHeader

|数据包类型|标识位|剩余长度|
|:--:|:--:|:--:|
|Byte1(7-4)|Byte1(3-0)|Byte2|

#### 数据包类型

#### 标识位

##### DUP

```
发布消息的副本。用来在保证消息的可靠传输，如果设置为 1，
则在下面的变长中增加 MessageId，并且需要回复确认，以保证消息传输完成，但不能用于检测消息重复发送。
```

##### QoS

```
发布消息的服务质量，即：保证消息传递的次数
Ø00：最多一次，即：<=1
Ø01：至少一次，即：>=1
Ø10：一次，即：=1
Ø11：预留
```

##### RETAIN

```
发布保留标识，表示服务器要保留这次推送的信息，
如果有新的订阅者出现，就把这消息推送给它，
如果设有那么推送至当前订阅者后释放。 
```

#### 剩余长度

```
固定头的第二字节用来保存变长头部和消息体的总大小的，但不是直接保存的。
这一字节是可以扩展，其保存机制，前7位用于保存长度，后一部用做标识。
当最后一位为 1 时，表示长度不足，需要使用二个字节继续保存。
```

### 可变头 VariableHeader

```
MQTT 数据包中包含一个可变头，它驻位于固定的头和负载之间。
可变头的内容因数据包类型而不同，较常的应用是作为包的标识：

很多类型数据包中都包括一个 2 字节的数据包标识字段，这些类型的包有：
PUBLISH (QoS > 0)
PUBACK
PUBREC
PUBREL
PUBCOMP
SUBSCRIBE
SUBACK
UNSUBSCRIBE
UNSUBACK
```

### 消息体 Payload

```
Payload 消息体位 MQTT 数据包的第三部分，包含
CONNECT
SUBSCRIBE
SUBACK
UNSUBSCRIBE
四种类型的消息：

（1）CONNECT，消息体内容主要是：客户端的 ClientID、订阅的 Topic、Message以及用户名和密码。
（2）SUBSCRIBE，消息体内容是一系列的要订阅的主题以及QoS。
（3）SUBACK，消息体内容是服务器对于 SUBSCRIBE 所申请的主题及 QoS 进行确认和回复。
（4）UNSUBSCRIBE，消息体内容是要订阅的主题。
```


## 参考

1. [官网](https://mqtt.org/)
2. [知乎大佬](https://zhuanlan.zhihu.com/p/20888181)
3. [Microsoft](https://docs.microsoft.com/zh-cn/archive/blogs/zhiqing/%E4%BD%BF%E7%94%A8mqtt%E5%8D%8F%E8%AE%AE%E5%BE%80android%E6%89%8B%E6%9C%BA%E6%8E%A8%E9%80%81%E6%B6%88%E6%81%AF)
